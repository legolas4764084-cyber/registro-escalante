<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>U.E. Las Delicias - Prof. Jaime Escalante</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>
    <style>
        /* Estilos iguales a la versión anterior, omitidos por brevedad. Copia los estilos del código previo aquí. */
    </style>
</head>
<body>

    <!-- Pantalla de Inicio (igual que antes) -->
    <div id="loginScreen">
        <h1>U.E. Las Delicias<br>Prof. Jaime Escalante</h1>
        <p>Sistema de Registro de Incidencias</p>
        <button class="btn-access btn-direccion" id="btnDireccion">DIRECCIÓN</button>
        <button class="btn-access btn-profesores" id="btnProfesores">PROFESORES</button>
    </div>

    <!-- Aplicación Principal (igual que antes, con secciones) -->
    <div id="mainApp">
        <!-- Header con logo (igual) -->
        <header>
            <img src="https://i.ibb.co.com/kc1K1nZ/logo-jaime-escalante.png" alt="Logo U.E. Las Delicias - Prof. Jaime Escalante">
            <h1>Unidad Educativa Las Delicias<br>Prof. Jaime Escalante - La Paz, Bolivia</h1>
            <button class="logout-btn" id="logoutBtn">Cerrar Sesión</button>
        </header>

        <div class="container">
            <!-- Secciones 1 a 4 iguales, pero sin localStorage -->
        </div>
    </div>

    <script>
        // Configura Firebase con TUS credenciales
        const firebaseConfig = {
            apiKey: "TU_API_KEY",
            authDomain: "TU_PROYECTO.firebaseapp.com",
            projectId: "TU_PROJECT_ID",
            storageBucket: "TU_PROYECTO.appspot.com",
            messagingSenderId: "TU_SENDER_ID",
            appId: "TU_APP_ID"
        };
        const app = firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        const CONTRASEÑA_DIRECCION = "JAIME ESCALANTE2026";
        let modoActual = null;

        // Funciones actualizadas para usar Firestore
        async function loadData() {
            const coursesSnapshot = await db.collection('courses').get();
            let courses = {};
            coursesSnapshot.forEach(doc => {
                courses[doc.id] = doc.data();
            });
            return { courses };
        }

        async function saveCourse(courseName, courseData) {
            await db.collection('courses').doc(courseName).set(courseData);
        }

        async function updateCourse(courseName, updatedData) {
            await db.collection('courses').doc(courseName).update(updatedData);
        }

        function updateCourseSelects(courses) {
            // Igual que antes, pero usando 'courses' cargados de Firestore
            const ids = ['selectCourseAddStudent', 'selectCourseIssue', 'selectCourseView', 'selectCourseStudent'];
            ids.forEach(id => {
                const select = document.getElementById(id);
                select.innerHTML = '<option value="">-- Seleccione un curso --</option>';
                Object.keys(courses).forEach(course => {
                    const opt = document.createElement('option');
                    opt.value = course;
                    opt.textContent = course;
                    select.appendChild(opt);
                });
            });
        }

        // Función para mostrar app y cargar datos
        async function mostrarApp() {
            document.getElementById('loginScreen').style.display = 'none';
            document.getElementById('mainApp').style.display = 'block';
            const data = await loadData();
            updateCourseSelects(data.courses);

            if (modoActual === 'profesor') {
                document.getElementById('sectionCrearCurso').classList.add('hidden');
                document.getElementById('sectionAgregarEstudiante').classList.add('hidden');
            }
        }

        // Eventos de login (iguales)

        // Crear curso
        document.getElementById('addCourseForm').addEventListener('submit', async e => {
            e.preventDefault();
            const name = document.getElementById('courseName').value.trim();
            const docRef = db.collection('courses').doc(name);
            const doc = await docRef.get();
            if (!doc.exists) {
                await saveCourse(name, { students: [] });
                const data = await loadData();
                updateCourseSelects(data.courses);
                alert('Curso creado.');
                document.getElementById('courseName').value = '';
            } else {
                alert('Curso ya existe.');
            }
        });

        // Agregar estudiante
        document.getElementById('addStudentForm').addEventListener('submit', async e => {
            e.preventDefault();
            const course = document.getElementById('selectCourseAddStudent').value;
            const name = document.getElementById('studentName').value.trim();
            if (course && name) {
                const docRef = db.collection('courses').doc(course);
                const doc = await docRef.get();
                if (doc.exists) {
                    const courseData = doc.data();
                    if (!courseData.students.find(s => s.name === name)) {
                        courseData.students.push({ name, issues: [] });
                        await updateCourse(course, courseData);
                        const data = await loadData();
                        updateStudentSelect('selectCourseIssue', 'selectStudent');
                        updateStudentSelect('selectCourseStudent', 'selectStudentView');
                        alert('Estudiante agregado.');
                        document.getElementById('studentName').value = '';
                    } else {
                        alert('Estudiante ya existe.');
                    }
                }
            }
        });

        // Registrar incidencia
        document.getElementById('registerIssueForm').addEventListener('submit', async e => {
            e.preventDefault();
            const course = document.getElementById('selectCourseIssue').value;
            const studentName = document.getElementById('selectStudent').value;
            const trimestre = document.getElementById('trimestre').value;
            const type = document.getElementById('issueType').value;
            const subject = document.getElementById('subject').value;
            const date = document.getElementById('issueDate').value;
            const desc = document.getElementById('issueDescription').value.trim();

            if (course && studentName && trimestre && type && subject && date && desc) {
                const docRef = db.collection('courses').doc(course);
                const doc = await docRef.get();
                if (doc.exists) {
                    const courseData = doc.data();
                    const student = courseData.students.find(s => s.name === studentName);
                    if (student) {
                        student.issues.push({ trimestre, type, subject, date, description: desc });
                        await updateCourse(course, courseData);
                        alert('Incidencia registrada.');
                        document.getElementById('issueDate').value = '';
                        document.getElementById('issueDescription').value = '';
                    }
                }
            }
        });

        // Ver registros (cargar desde Firestore)
        document.getElementById('viewRecordsBtn').addEventListener('click', async () => {
            const data = await loadData();
            // Resto del código igual, usando data.courses
        });

        // Export PDF igual

    </script>
</body>
</html>
