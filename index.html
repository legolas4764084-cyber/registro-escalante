<!-- ... (tu <head> y estilos permanecen iguales) ... -->

<div class="section">
    <h2>4. Ver Registros</h2>
    <label for="viewType">Tipo de vista:</label>
    <select id="viewType">
        <option value="course">Por Curso</option>
        <option value="student">Por Estudiante</option>
    </select>

    <!-- Vista por Curso -->
    <div id="viewByCourse" style="display:none; margin-top:20px;">
        <label for="selectCourseView">Seleccionar Curso:</label>
        <select id="selectCourseView"></select>
    </div>

    <!-- Vista por Estudiante (con trimestres) -->
    <div id="viewByStudent" style="display:none; margin-top:20px;">
        <div style="display:flex; flex-wrap:wrap; gap:20px; align-items:flex-end;">
            <div style="flex:1; min-width:220px;">
                <label for="selectCourseStudent">Seleccionar Curso:</label>
                <select id="selectCourseStudent"></select>
            </div>

            <div style="flex:1; min-width:220px;">
                <label for="selectStudentView">Seleccionar Estudiante:</label>
                <select id="selectStudentView"></select>
            </div>

            <div style="flex:1; min-width:220px;" id="divTrimestreEstudiante" class="hidden">
                <label for="selectTrimestreEstudiante">Seleccionar Trimestre:</label>
                <select id="selectTrimestreEstudiante">
                    <option value="">-- Todos --</option>
                    <option value="1er Trimestre">1er Trimestre</option>
                    <option value="2do Trimestre">2do Trimestre</option>
                    <option value="3er Trimestre">3er Trimestre</option>
                </select>
            </div>
        </div>

        <button id="viewStudentBtn" style="margin-top:20px;">Ver Registros del Estudiante</button>
    </div>

    <button id="viewRecordsBtn" style="margin:20px 10px 0 0;">Ver Registros</button>
    <button id="exportPdfBtn" style="display:none; margin-left:10px;">Exportar a PDF</button>

    <div id="recordsContainer" style="margin-top:30px;">
        <div id="recordsTable"></div>
    </div>
</div>

<!-- ... resto de tu HTML ... -->

<script>
// ... (tu firebaseConfig y otras funciones permanecen iguales) ...

// Cargar cursos en TODOS los selects al iniciar
function updateCourseSelects() {
    const selects = [
        'selectCourseAddStudent', 'selectCourseIssue',
        'selectCourseView', 'selectCourseStudent'
    ];
    db.collection('courses').get().then(snapshot => {
        selects.forEach(id => {
            const select = document.getElementById(id);
            if (select) {
                select.innerHTML = '<option value="">-- Seleccione curso --</option>';
                snapshot.forEach(doc => {
                    const opt = document.createElement('option');
                    opt.value = doc.id;
                    opt.textContent = doc.id;
                    select.appendChild(opt);
                });
            }
        });
    }).catch(err => console.error("Error cargando cursos:", err));
}

// Cargar estudiantes cuando se selecciona curso
function updateStudentSelect(courseSelectId, studentSelectId) {
    const course = document.getElementById(courseSelectId)?.value;
    const select = document.getElementById(studentSelectId);
    if (!select) return;

    select.innerHTML = '<option value="">-- Seleccione estudiante --</option>';

    if (!course) return;

    db.collection('courses').doc(course).get().then(doc => {
        if (doc.exists) {
            const students = doc.data().students || [];
            students.forEach(s => {
                const opt = document.createElement('option');
                opt.value = s.name;
                opt.textContent = s.name;
                select.appendChild(opt);
            });
            // Mostrar selector de trimestre solo si ya hay estudiante seleccionado
            if (studentSelectId === 'selectStudentView') {
                document.getElementById('divTrimestreEstudiante').classList.toggle('hidden', !course || !select.value);
            }
        }
    }).catch(err => console.error("Error cargando estudiantes:", err));
}

// Mostrar/ocultar vistas
document.getElementById('viewType').addEventListener('change', function() {
    const type = this.value;
    document.getElementById('viewByCourse').style.display = type === 'course' ? 'block' : 'none';
    document.getElementById('viewByStudent').style.display = type === 'student' ? 'block' : 'none';
});

// Cargar estudiantes al cambiar curso en vista por estudiante
document.getElementById('selectCourseStudent').addEventListener('change', function() {
    updateStudentSelect('selectCourseStudent', 'selectStudentView');
});

// Mostrar selector de trimestre solo cuando ya hay estudiante
document.getElementById('selectStudentView').addEventListener('change', function() {
    const hasSelection = document.getElementById('selectCourseStudent').value && this.value;
    document.getElementById('divTrimestreEstudiante').classList.toggle('hidden', !hasSelection);
});

// Ver registros por estudiante + trimestre
document.getElementById('viewStudentBtn').addEventListener('click', () => {
    const course = document.getElementById('selectCourseStudent').value;
    const studentName = document.getElementById('selectStudentView').value;
    const trimestre = document.getElementById('selectTrimestreEstudiante').value;

    if (!course || !studentName) {
        alert("Seleccione curso y estudiante primero");
        return;
    }

    const container = document.getElementById('recordsTable');
    container.innerHTML = '<p>Cargando registros...</p>';
    document.getElementById('exportPdfBtn').style.display = 'none';

    db.collection('courses').doc(course).get().then(doc => {
        if (!doc.exists) return container.innerHTML = '<p>Curso no encontrado.</p>';

        const data = doc.data();
        const student = data.students.find(s => s.name === studentName);
        if (!student) return container.innerHTML = '<p>Estudiante no encontrado.</p>';

        let issues = student.issues || [];
        if (trimestre) {
            issues = issues.filter(i => i.trimestre === trimestre);
        }

        if (issues.length === 0) {
            container.innerHTML = `<p>No hay incidencias${trimestre ? ' en ' + trimestre : ''} para ${studentName}.</p>`;
            return;
        }

        issues.sort((a,b) => new Date(b.date) - new Date(a.date));

        let html = `<h3>Registros de ${studentName} (${course}) ${trimestre ? '- ' + trimestre : ''}</h3>`;
        html += '<table><thead><tr><th>Trimestre</th><th>Tipo</th><th>Materia</th><th>Fecha</th><th>Descripción</th></tr></thead><tbody>';

        issues.forEach(i => {
            const typeText = {
                falta: 'Falta',
                incumplimiento: 'Incumplimiento',
                indisciplina: 'Indisciplina',
                citacion: 'Citación'
            }[i.type] || i.type;

            html += `<tr>
                <td>${i.trimestre}</td>
                <td>${typeText}</td>
                <td>${i.subject}</td>
                <td>${i.date}</td>
                <td>${i.description}</td>
            </tr>`;
        });

        html += '</tbody></table>';
        container.innerHTML = html;
        document.getElementById('exportPdfBtn').style.display = 'inline-block';
    }).catch(err => {
        container.innerHTML = '<p>Error al cargar: ' + err.message + '</p>';
        console.error(err);
    });
});

// Inicializar al cargar
updateCourseSelects();
mostrarApp();
</script>
