<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>U.E. Las Delicias - Prof. Jaime Escalante</title>

    <!-- Firebase Compat -->
    <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-auth-compat.js"></script>

    <!-- jsPDF + html2canvas -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            font-family: Arial, Helvetica, sans-serif;
            background: #f0f2f5;
            min-height: 100vh;
            color: #333;
        }
        #loginScreen {
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background: linear-gradient(to bottom, #1e3c72, #2a5298);
            color: white;
            text-align: center;
            padding: 20px;
        }
        #loginScreen h1 { font-size: 2.8em; margin-bottom: 20px; text-shadow: 2px 2px 6px rgba(0,0,0,0.5); }
        #loginScreen p { font-size: 1.3em; margin-bottom: 40px; }
        .btn-access {
            width: 320px;
            padding: 20px;
            margin: 15px;
            font-size: 1.5em;
            font-weight: bold;
            color: white;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 6px 15px rgba(0,0,0,0.3);
        }
        .btn-direccion { background: #c0392b; }
        .btn-profesores { background: #27ae60; }
        .btn-access:hover { transform: translateY(-4px); box-shadow: 0 10px 20px rgba(0,0,0,0.4); }

        #mainApp { display: none; min-height: 100vh; }
        header {
            background: #1e3c72;
            color: white;
            padding: 20px;
            text-align: center;
            position: relative;
        }
        header img { 
            height: 100px; 
            margin-bottom: 10px; 
            border-radius: 8px; 
            box-shadow: 0 4px 12px rgba(0,0,0,0.3); 
        }
        .logout-btn {
            position: absolute;
            top: 20px;
            right: 20px;
            background: #c0392b;
            color: white;
            border: none;
            padding: 10px 18px;
            border-radius: 6px;
            cursor: pointer;
        }
        .container {
            width: 90%;
            max-width: 1100px;
            margin: 30px auto;
            padding: 0 15px;
        }
        h2 {
            color: #1e3c72;
            border-bottom: 3px solid #2a5298;
            padding-bottom: 10px;
            margin-bottom: 20px;
        }
        form {
            background: white;
            padding: 25px;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            margin-bottom: 35px;
        }
        label { font-weight: bold; display: block; margin: 12px 0 6px; }
        input, select {
            width: 100%;
            padding: 12px;
            margin-bottom: 15px;
            border: 1px solid #ccc;
            border-radius: 6px;
            font-size: 1em;
        }
        button:not(.btn-access):not(.logout-btn):not(.btn-delete-all) {
            background: #2a5298;
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 1.05em;
        }
        button:hover:not(.btn-access):not(.logout-btn):not(.btn-delete-all) { background: #1e3c72; }

        .btn-delete-all {
            background: #e74c3c;
            color: white;
            padding: 14px 30px;
            font-size: 1.2em;
            font-weight: bold;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            margin-top: 30px;
            box-shadow: 0 4px 12px rgba(231, 76, 60, 0.4);
        }
        .btn-delete-all:hover {
            background: #c0392b;
            transform: translateY(-2px);
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            background: white;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        th, td { border: 1px solid #ddd; padding: 12px; text-align: left; }
        th { background: #1e3c72; color: white; }
        .section { margin-bottom: 50px; }
        .hidden { display: none !important; }
        #recordsContainer {
            background: white;
            padding: 25px;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        .delete-section {
            background: #fff5f5;
            border: 2px solid #e74c3c;
            border-radius: 10px;
            padding: 25px;
            margin-top: 60px;
            text-align: center;
        }
        .delete-section h3 {
            color: #c0392b;
            margin-bottom: 15px;
        }
        .filter-row { display: flex; flex-wrap: wrap; gap: 20px; align-items: flex-end; margin: 20px 0; }
        .filter-row > div { flex: 1; min-width: 220px; }
    </style>
</head>
<body>

<div id="loginScreen">
    <h1>U.E. Las Delicias<br>Prof. Jaime Escalante</h1>
    <p>Sistema de Registro de Incidencias</p>
    <button class="btn-access btn-direccion" id="btnDireccion">DIRECCIÓN</button>
    <button class="btn-access btn-profesores" id="btnProfesores">PROFESORES</button>
</div>

<div id="mainApp">
    <header>
        <img src="https://i.ibb.co/kc1K1nZ/logo-jaime-escalante.png" alt="Logo U.E. Las Delicias" 
             onerror="this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTAwIiBoZWlnaHQ9IjEwMCIgdmlld0JveD0iMCAwIDEwMCAxMDAiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+PHJlY3Qgd2lkdGg9IjEwMCIgaGVpZ2h0PSIxMDAiIGZpbGw9IiM0Q0E1RkYiLz48dGV4dCB4PSI1MCIgeT0iNjAiIGZvbnQtc2l6ZT0iNDAiIHRleHQtYW5jaG9yPSJtaWRkbGUiIGZpbGw9IndoaXRlIj5MT0dPPC90ZXh0Pjwvc3ZnPg=='">
        <h1>Unidad Educativa Las Delicias<br>Prof. Jaime Escalante - La Paz, Bolivia</h1>
        <button class="logout-btn" id="logoutBtn">Cerrar Sesión</button>
    </header>

    <div class="container">

        <div class="section hidden" id="sectionCrearCurso">
            <h2>1. Crear un Nuevo Curso</h2>
            <form id="addCourseForm">
                <label for="courseName">Nombre del Curso (ej: 5to A):</label>
                <input type="text" id="courseName" required placeholder="Ej: 10mo Humanidades">
                <button type="submit">Crear Curso</button>
            </form>
        </div>

        <div class="section hidden" id="sectionAgregarEstudiante">
            <h2>2. Agregar Estudiantes a un Curso</h2>
            
            <form id="addStudentsForm">
                <label for="selectCourseAddStudent">Seleccionar Curso:</label>
                <select id="selectCourseAddStudent" required></select>

                <label for="fileStudents">Subir lista de estudiantes (TXT o CSV):</label>
                <input type="file" id="fileStudents" accept=".txt, .csv" required>

                <div id="csvPreview" style="margin: 15px 0; max-height: 200px; overflow-y: auto; display: none; background: #f8f9fa; padding: 12px; border: 1px solid #ccc; border-radius: 6px;"></div>

                <p style="font-size: 0.9em; color: #555; margin: 10px 0;">
                    Formato recomendado (una columna):<br>
                    Puedes incluir o no el encabezado "Nombre"
                </p>
                <pre style="background:#f8f8f8; padding:10px; border-radius:6px; font-size:0.95em; margin-bottom:15px;">
Nombre
Juan Pérez Gómez
María López Ramírez
Ana Fernández S.
Carlos A. Mamani
                </pre>

                <button type="submit">Validar y Agregar Estudiantes</button>
            </form>

            <!-- Opción individual -->
            <hr style="margin: 40px 0 20px;">
            <h3>Agregar un estudiante individualmente:</h3>
            <form id="addStudentForm">
                <label for="selectCourseAddSingle">Seleccionar Curso:</label>
                <select id="selectCourseAddSingle" required></select>
                <label for="studentName">Nombre Completo del Estudiante:</label>
                <input type="text" id="studentName" required placeholder="Ej: Juan Pérez Rojas">
                <button type="submit">Agregar Estudiante</button>
            </form>
        </div>

        <div class="section" id="sectionRegistrarIncidencia">
            <h2>3. Registrar Incidencia</h2>
            <form id="registerIssueForm">
                <label for="selectCourseIssue">Seleccionar Curso:</label>
                <select id="selectCourseIssue" required></select>
                <label for="selectStudent">Seleccionar Estudiante:</label>
                <select id="selectStudent" required></select>
                <label for="trimestre">Trimestre:</label>
                <select id="trimestre" required>
                    <option value="1er Trimestre">1er Trimestre</option>
                    <option value="2do Trimestre">2do Trimestre</option>
                    <option value="3er Trimestre">3er Trimestre</option>
                </select>
                <label for="issueType">Tipo de Incidencia:</label>
                <select id="issueType" required>
                    <option value="falta">Falta (Ausencia)</option>
                    <option value="incumplimiento">Incumplimiento</option>
                    <option value="indisciplina">Indisciplina</option>
                    <option value="citacion">Citación</option>
                    <option value="compromiso">Compromiso</option>
                </select>
                <label for="subject">Materia:</label>
                <select id="subject" required>
                    <option value="REG">REG - Regencia</option>
                    <option value="DIR">DIR - Dirección</option>
                    <option value="MAT">MAT - Matemáticas</option>
                    <option value="LCO">LCO - Lenguaje</option>
                    <option value="LEX">LEX - Inglés</option>
                    <option value="CS">CS - Ciencias Sociales</option>
                    <option value="EFI">EFI - Educación Física</option>
                    <option value="EMU">EMU - Música</option>
                    <option value="VER">VER - Religión</option>
                    <option value="APV">APV - Artes Plásticas</option>
                    <option value="CFP">CFP - Filosofía</option>
                    <option value="TTG">TTG - Tecnología</option>
                    <option value="BG">BG - Biología</option>
                    <option value="CQ">CQ - Química</option>
                    <option value="CF">CF - Física</option>
                    <option value="COM/PED">COM/PED - Comisión Pedagógica</option>
                    <option value="COM/DISC">COM/DISC - Comisión Disciplinaria</option>
                </select>
                <label for="issueDate">Fecha:</label>
                <input type="date" id="issueDate" required>
                <label for="issueDescription">Descripción:</label>
                <input type="text" id="issueDescription" required placeholder="Describa la incidencia">
                <button type="submit">Registrar Incidencia</button>
            </form>
        </div>

        <!-- Sección solo para DIRECCIÓN -->
        <div class="section hidden" id="sectionAdminTools">
            <div class="delete-section">
                <h3>Zona de Administración - Borrado Total</h3>
                <p style="color: #c0392b; font-weight: bold; margin-bottom: 20px;">
                    ¡Cuidado! Esta acción eliminará TODOS los cursos, estudiantes e incidencias permanentemente.
                </p>
                <button class="btn-delete-all" id="btnBorrarTodo">BORRAR TODOS LOS DATOS</button>
            </div>
        </div>

        <div class="section">
            <h2>4. Ver Registros</h2>

            <!-- Vista directa por Estudiante -->
            <div class="filter-row">
                <div>
                    <label for="selectCourseStudent">Seleccionar Curso:</label>
                    <select id="selectCourseStudent"></select>
                </div>

                <div>
                    <label for="selectStudentView">Seleccionar Estudiante:</label>
                    <select id="selectStudentView"></select>
                </div>

                <div id="divTrimestreEstudiante" class="hidden">
                    <label for="selectTrimestreEstudiante">Seleccionar Trimestre:</label>
                    <select id="selectTrimestreEstudiante">
                        <option value="">-- Todos los trimestres --</option>
                        <option value="1er Trimestre">1er Trimestre</option>
                        <option value="2do Trimestre">2do Trimestre</option>
                        <option value="3er Trimestre">3er Trimestre</option>
                    </select>
                </div>
            </div>

            <button id="viewStudentBtn" style="margin-top:20px;">Ver Registros del Estudiante</button>

            <div id="recordsContainer" style="margin-top:40px;">
                <div id="recordsTable"></div>
            </div>

            <button id="exportPdfBtn" style="display:none; margin-top:20px;">Exportar a PDF</button>
        </div>

    </div>
</div>

<script>
// Firebase Config
const firebaseConfig = {
  apiKey: "AIzaSyCn6Q-HxzCtd1rln_RSyyYgAvr_uz2pQ9A",
  authDomain: "gestion-ue-las-delicias.firebaseapp.com",
  projectId: "gestion-ue-las-delicias",
  storageBucket: "gestion-ue-las-delicias.firebasestorage.app",
  messagingSenderId: "548742390776",
  appId: "1:548742390776:web:d3ea4cc96b8711568cac0d",
  measurementId: "G-HSC2D59DGY"
};

const app = firebase.initializeApp(firebaseConfig);
const db = firebase.firestore(app);
const auth = firebase.auth(app);

// Sign in anonymously to allow writes if rules require auth
auth.signInAnonymously()
  .then(() => {
    console.log('Signed in anonymously');
  })
  .catch((error) => {
    console.error('Error signing in anonymously', error);
  });

const CONTRASEÑA_DIRECCION = "JAIMEESCALANTE2026";
let modoActual = null;

// Cargar cursos en todos los selects relevantes
function updateCourseSelects() {
    const selects = [
        'selectCourseAddStudent',
        'selectCourseAddSingle',
        'selectCourseIssue',
        'selectCourseStudent'
    ];
    db.collection('courses').get().then(snapshot => {
        selects.forEach(id => {
            const select = document.getElementById(id);
            if (select) {
                select.innerHTML = '<option value="">-- Seleccione curso --</option>';
                snapshot.forEach(doc => {
                    const opt = document.createElement('option');
                    opt.value = doc.id;
                    opt.textContent = doc.id;
                    select.appendChild(opt);
                });
            }
        });
    }).catch(err => console.error("Error cargando cursos:", err));
}

// Cargar estudiantes cuando cambia el curso
function updateStudentSelect(courseSelectId, studentSelectId) {
    const course = document.getElementById(courseSelectId)?.value;
    const select = document.getElementById(studentSelectId);
    if (!select) return;

    select.innerHTML = '<option value="">-- Seleccione estudiante --</option>';

    if (!course) return;

    db.collection('courses').doc(course).get().then(doc => {
        if (doc.exists) {
            const students = doc.data().students || [];
            students.forEach(s => {
                const opt = document.createElement('option');
                opt.value = s.name;
                opt.textContent = s.name;
                select.appendChild(opt);
            });
            // Mostrar selector de trimestre si estamos en vista por estudiante
            if (studentSelectId === 'selectStudentView') {
                const student = select.value;
                document.getElementById('divTrimestreEstudiante').classList.toggle('hidden', !course || !student);
            }
        }
    }).catch(err => console.error("Error cargando estudiantes:", err));
}

// Mostrar la aplicación según rol
function mostrarApp() {
    document.getElementById('loginScreen').style.display = 'none';
    document.getElementById('mainApp').style.display = 'block';
    updateCourseSelects();

    if (modoActual === 'direccion') {
        document.getElementById('sectionAdminTools').classList.remove('hidden');
        document.getElementById('sectionCrearCurso').classList.remove('hidden');
        document.getElementById('sectionAgregarEstudiante').classList.remove('hidden');
    } else {
        document.getElementById('sectionCrearCurso').classList.add('hidden');
        document.getElementById('sectionAgregarEstudiante').classList.add('hidden');
        document.getElementById('sectionAdminTools').classList.add('hidden');
    }
}

// Eventos de login
document.getElementById('btnDireccion').addEventListener('click', () => {
    const pass = prompt("Contraseña para DIRECCIÓN:");
    if (pass === CONTRASEÑA_DIRECCION) {
        modoActual = 'direccion';
        mostrarApp();
    } else {
        alert("Contraseña incorrecta.");
    }
});

document.getElementById('btnProfesores').addEventListener('click', () => {
    if (confirm("¿Ingresar como PROFESOR?\n(Solo registro de incidencias)")) {
        modoActual = 'profesor';
        mostrarApp();
    }
});

document.getElementById('logoutBtn').addEventListener('click', () => {
    if (confirm("¿Cerrar sesión?")) {
        document.getElementById('mainApp').style.display = 'none';
        document.getElementById('loginScreen').style.display = 'flex';
        modoActual = null;
    }
});

// Crear curso
document.getElementById('addCourseForm')?.addEventListener('submit', e => {
    e.preventDefault();
    const name = document.getElementById('courseName').value.trim();
    if (!name) return alert("Ingrese nombre del curso");

    db.collection('courses').doc(name).get().then(doc => {
        if (doc.exists) {
            alert("El curso ya existe");
        } else {
            db.collection('courses').doc(name).set({ students: [] })
                .then(() => {
                    alert("Curso creado");
                    document.getElementById('courseName').value = '';
                    updateCourseSelects();
                })
                .catch(err => {
                    console.error("Error al crear curso:", err);
                    alert("Error: " + err.message);
                });
        }
    }).catch(err => {
        console.error("Error al verificar curso:", err);
        alert("Error: " + err.message);
    });
});

// Agregar estudiante individual
document.getElementById('addStudentForm')?.addEventListener('submit', e => {
    e.preventDefault();
    const course = document.getElementById('selectCourseAddSingle').value;
    const name = document.getElementById('studentName').value.trim();
    if (!course || !name) return alert("Complete los campos");

    db.collection('courses').doc(course).get().then(doc => {
        if (!doc.exists) return alert("Curso no encontrado");

        const data = doc.data();
        if (data.students.some(s => s.name === name)) {
            alert("El estudiante ya está en este curso");
            return;
        }

        data.students.push({ name, issues: [] });
        db.collection('courses').doc(course).update({ students: data.students })
            .then(() => {
                alert("Estudiante agregado");
                document.getElementById('studentName').value = '';
                updateStudentSelect('selectCourseIssue', 'selectStudent');
                updateStudentSelect('selectCourseStudent', 'selectStudentView');
            })
            .catch(err => alert("Error: " + err.message));
    });
});

// Agregar múltiples estudiantes desde TXT/CSV con validaciones robustas
document.getElementById('addStudentsForm')?.addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const course = document.getElementById('selectCourseAddStudent').value;
    const fileInput = document.getElementById('fileStudents');
    const previewDiv = document.getElementById('csvPreview');
    
    if (!course) return alert("Selecciona un curso primero");
    if (!fileInput.files?.length) return alert("Selecciona un archivo TXT o CSV");

    const file = fileInput.files[0];
    
    try {
        const text = await file.text();
        const lines = text.split(/\r?\n/)
                         .map(line => line.trim())
                         .filter(line => line.length > 0);

        if (lines.length === 0) return alert("El archivo está vacío");

        // Determinar si hay encabezado
        let startIndex = 0;
        if (lines[0].toLowerCase().trim().match(/^nombre$/i) || 
            lines[0].toLowerCase().includes("nombre")) {
            startIndex = 1; // saltamos el encabezado
        }

        const names = lines.slice(startIndex)
                           .map(name => name.trim())
                           .filter(name => name.length > 0);

        if (names.length === 0) return alert("No se encontraron nombres válidos después del encabezado (si lo hay)");

        // ────────────────────────────────────────────────
        // VALIDACIONES POR NOMBRE
        // ────────────────────────────────────────────────
        const validNames = [];
        const invalidNames = [];
        const seenInFile = new Set(); // para detectar duplicados dentro del archivo

        const nameRegex = /^[A-Za-zÁÉÍÓÚáéíóúÑñÜü\s.'-]{2,80}$/;

        names.forEach((name, index) => {
            const originalLine = index + startIndex + 1;

            if (!nameRegex.test(name)) {
                invalidNames.push(`Línea ${originalLine}: "${name}" → no válido (solo letras, espacios, acentos, ñ, guiones, puntos; min 2 caracteres)`);
                return;
            }

            const normalized = name.toLowerCase().trim();
            
            if (seenInFile.has(normalized)) {
                invalidNames.push(`Línea ${originalLine}: "${name}" → duplicado dentro del archivo`);
                return;
            }

            seenInFile.add(normalized);
            validNames.push(name.trim());
        });

        // Mostrar preview con validación visual
        let previewHTML = `<strong>${validNames.length} nombres válidos encontrados | ${invalidNames.length} con problemas</strong><br><br>`;
        
        if (validNames.length > 0) {
            previewHTML += "<strong>Válidos:</strong><ul style='margin:8px 0 15px 20px;'>";
            validNames.slice(0, 15).forEach(n => previewHTML += `<li>${n}</li>`);
            if (validNames.length > 15) previewHTML += `<li>... y ${validNames.length - 15} más</li>`;
            previewHTML += "</ul>";
        }

        if (invalidNames.length > 0) {
            previewHTML += "<strong>Problemas detectados:</strong><ul style='color:#c00; margin:8px 0 15px 20px;'>";
            invalidNames.slice(0, 10).forEach(err => previewHTML += `<li>${err}</li>`);
            if (invalidNames.length > 10) previewHTML += `<li>... y ${invalidNames.length - 10} más</li>`;
            previewHTML += "</ul>";
        }

        previewDiv.innerHTML = previewHTML;
        previewDiv.style.display = 'block';

        if (validNames.length === 0) {
            return alert("No hay nombres válidos para agregar. Corrige el archivo e inténtalo de nuevo.");
        }

        if (invalidNames.length > 0 && !confirm(`Hay ${invalidNames.length} nombres con problemas.\n¿Quieres continuar solo con los ${validNames.length} válidos?`)) {
            return;
        }

        // ────────────────────────────────────────────────
        // Comparar con los que ya existen en Firestore
        // ────────────────────────────────────────────────
        const docRef = db.collection('courses').doc(course);
        const doc = await docRef.get();
        
        if (!doc.exists) return alert("Curso no encontrado");

        const data = doc.data();
        let students = data.students || [];
        const existingNames = new Set(students.map(s => s.name.toLowerCase().trim()));

        let addedCount = 0;
        let duplicates = 0;

        validNames.forEach(name => {
            const normalized = name.toLowerCase().trim();
            if (existingNames.has(normalized)) {
                duplicates++;
                return;
            }

            students.push({ 
                name: name.trim(), 
                issues: [] 
            });
            addedCount++;
            existingNames.add(normalized); // para evitar duplicados en la misma carga
        });

        if (addedCount === 0) {
            return alert(`No se agregaron nuevos estudiantes.\n${duplicates > 0 ? duplicates + ' ya existían en el curso.' : 'Revisa las validaciones.'}`);
        }

        await docRef.update({ students });

        alert(`¡Éxito! Se agregaron ${addedCount} estudiantes nuevos.\n${duplicates > 0 ? duplicates + ' ya existían en el curso.' : ''}`);

        // Limpiar
        fileInput.value = '';
        previewDiv.style.display = 'none';
        previewDiv.innerHTML = '';

        // Actualizar selects
        updateStudentSelect('selectCourseIssue', 'selectStudent');
        updateStudentSelect('selectCourseStudent', 'selectStudentView');

    } catch (err) {
        console.error("Error procesando archivo:", err);
        alert("Error al leer/procesar el archivo:\n" + err.message);
    }
});

// Registrar incidencia
document.getElementById('registerIssueForm').addEventListener('submit', (e) => {
    e.preventDefault();
    const course = document.getElementById('selectCourseIssue').value;
    const studentName = document.getElementById('selectStudent').value;
    const trimestre = document.getElementById('trimestre').value;
    const type = document.getElementById('issueType').value;
    const subject = document.getElementById('subject').value;
    const date = document.getElementById('issueDate').value;
    const description = document.getElementById('issueDescription').value.trim();

    if (!course || !studentName || !trimestre || !type || !subject || !date || !description) {
        return alert('Complete todos los campos.');
    }

    db.collection('courses').doc(course).get().then(doc => {
        if (doc.exists) {
            const students = doc.data().students || [];
            const studentIndex = students.findIndex(s => s.name === studentName);
            if (studentIndex === -1) return alert('Estudiante no encontrado.');

            const issue = { trimestre, type, subject, date, description };
            students[studentIndex].issues = students[studentIndex].issues || [];
            students[studentIndex].issues.push(issue);
            return db.collection('courses').doc(course).update({ students });
        } else {
            alert('Curso no encontrado.');
        }
    }).then(() => {
        alert('Incidencia registrada exitosamente.');
        document.getElementById('registerIssueForm').reset();
    }).catch(err => {
        console.error('Error registrando incidencia:', err);
        alert('Error al registrar incidencia: ' + err.message);
    });
});

// Borrar todos los datos
document.getElementById('btnBorrarTodo').addEventListener('click', () => {
    if (confirm('¿Está seguro de borrar TODOS los datos? Esta acción es irreversible.')) {
        db.collection('courses').get().then(snapshot => {
            const batch = db.batch();
            snapshot.forEach(doc => batch.delete(doc.ref));
            return batch.commit();
        }).then(() => {
            alert('Todos los datos han sido borrados.');
            updateCourseSelects();
        }).catch(err => {
            console.error('Error borrando datos:', err);
            alert('Error al borrar datos: ' + err.message);
        });
    }
});

// Ver registros por estudiante + trimestre
document.getElementById('viewStudentBtn').addEventListener('click', () => {
    const course = document.getElementById('selectCourseStudent').value;
    const studentName = document.getElementById('selectStudentView').value;
    const trimestre = document.getElementById('selectTrimestreEstudiante').value;

    if (!course || !studentName) {
        alert("Seleccione curso y estudiante primero");
        return;
    }

    const container = document.getElementById('recordsTable');
    container.innerHTML = '<p>Cargando...</p>';
    document.getElementById('exportPdfBtn').style.display = 'none';

    db.collection('courses').doc(course).get().then(doc => {
        if (!doc.exists) return container.innerHTML = '<p>Curso no encontrado.</p>';

        const data = doc.data();
        const student = data.students.find(s => s.name === studentName);
        if (!student) return container.innerHTML = '<p>Estudiante no encontrado.</p>';

        let issues = student.issues || [];
        if (trimestre) {
            issues = issues.filter(i => i.trimestre === trimestre);
        }

        if (issues.length === 0) {
            container.innerHTML = `<p>No hay incidencias${trimestre ? ' en ' + trimestre : ''} para ${studentName}.</p>`;
            return;
        }

        issues.sort((a,b) => new Date(b.date) - new Date(a.date));

        let html = `<h3>Registros de ${studentName} (${course}) ${trimestre ? '- ' + trimestre : ''}</h3>`;
        html += '<table><thead><tr><th>Trimestre</th><th>Tipo</th><th>Materia</th><th>Fecha</th><th>Descripción</th></tr></thead><tbody>';

        issues.forEach(i => {
            const typeText = {
                falta: 'Falta',
                incumplimiento: 'Incumplimiento',
                indisciplina: 'Indisciplina',
                citacion: 'Citación'
            }[i.type] || i.type;

            html += `<tr>
                <td>${i.trimestre}</td>
                <td>${typeText}</td>
                <td>${i.subject}</td>
                <td>${i.date}</td>
                <td>${i.description}</td>
            </tr>`;
        });

        html += '</tbody></table>';
        container.innerHTML = html;
        document.getElementById('exportPdfBtn').style.display = 'inline-block';
    }).catch(err => {
        container.innerHTML = '<p>Error al cargar datos: ' + err.message + '</p>';
        console.error(err);
    });
});

// Función para exportar a PDF
document.getElementById('exportPdfBtn').addEventListener('click', async () => {
    const { jsPDF } = window.jspdf;
    const content = document.getElementById('recordsTable');
    try {
        const canvas = await html2canvas(content, { scale: 2 });
        const pdf = new jsPDF({
            orientation: canvas.width > canvas.height ? 'landscape' : 'portrait',
            unit: 'px',
            format: [canvas.width, canvas.height]
        });
        pdf.addImage(canvas.toDataURL('image/png'), 'PNG', 0, 0, canvas.width, canvas.height);
        pdf.save('Reporte_Incidencias.pdf');
    } catch (err) {
        alert("Error al generar PDF: " + err.message);
        console.error(err);
    }
});

// Inicialización de eventos para carga de estudiantes
document.addEventListener('DOMContentLoaded', () => {
    // Evento para cargar estudiantes al seleccionar curso en registrar incidencia
    document.getElementById('selectCourseIssue').addEventListener('change', () => {
        updateStudentSelect('selectCourseIssue', 'selectStudent');
    });

    // Evento para cargar estudiantes al seleccionar curso en ver registros
    document.getElementById('selectCourseStudent').addEventListener('change', () => {
        updateStudentSelect('selectCourseStudent', 'selectStudentView');
    });

    // Evento para mostrar el div de trimestre al seleccionar estudiante en ver registros
    document.getElementById('selectStudentView').addEventListener('change', () => {
        const course = document.getElementById('selectCourseStudent').value;
        const student = document.getElementById('selectStudentView').value;
        document.getElementById('divTrimestreEstudiante').classList.toggle('hidden', !course || !student);
    });
});
</script>
</body>
</html>

